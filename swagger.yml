swagger: '2.0'
info:
  description: >
    This is an instance of Weles. [More about this instance of
    Weles.](http://weles.yourdomain.com).
  version: v1
  title: Weles
  termsOfService: 'http://weles.yourdomain.com/terms/'
  contact:
    email: admin@yourdomain.com
  license:
    name: Apache 2.0
    url: 'http://www.apache.org/licenses/LICENSE-2.0.html'
host: 'localhost:5010'
basePath: /api/v1
consumes:
  - application/json
produces:
  - application/json
tags:
  - name: jobs
    description: Info and management of Weles Jobs.
  - name: artifacts
    description: Info about Artifacts used by Weles Jobs.
  - name: general
    description: Info about Weles (e.g. version)
schemes:
  - http
paths:
  /jobs:
    options:
      tags:
        - jobs
      summary: OPTIONS path for CORS.
      description: ""
      operationId: JobCreatorOptions
      responses:
         '200':
          description: 200 OK
          headers:
            Access-Control-Allow-Origin:
              type: string
            Access-Control-Allow-Headers:
              type: array
              items:
                type: string
              collectionFormat: csv
            Access-Control-Allow-Methods:
              type: array
              items:
                type: string
              collectionFormat: csv
    post:
      tags:
        - jobs
      summary: Add new Job
      description: >
        Add new Job to Weles. Job submission should be in YAML format. User
        will receive JobID number in response. Parsing the file and
        downloading Artifacts (if necessary) will be performed immidiately.
        Job will be executed when worker will be available. JobLister path
        should be used to query Weles for Job progress.
      operationId: JobCreator
      consumes:
        - multipart/form-data
      parameters:
        - in: formData
          name: yamlfile
          type: file
          required: true
          description: is Job description yaml file.
      produces:
        - application/json
      responses:
        '201':
          description: Created
          schema:
            $ref: '#/definitions/JobID'
        '415':
          $ref: '#/responses/UnsupportedMediaType'
        '422':
          $ref: '#/responses/UnprocessableEntity'
        '500':
          $ref: '#/responses/InternalServer'
  '/jobs/{JobID}/cancel':
    options:
      tags:
        - jobs
      summary: OPTIONS path for CORS.
      description: ""
      operationId: JobCancelerOptions
      parameters:
        - in: path
          required: true
          name: JobID
          type: integer
          format: uint64
      responses:
         '200':
          description: 200 OK
          headers:
            Access-Control-Allow-Origin:
              type: string
            Access-Control-Allow-Headers:
              type: array
              items:
                type: string
              collectionFormat: csv
            Access-Control-Allow-Methods:
              type: array
              items:
                type: string
              collectionFormat: csv
    post:
      tags:
        - jobs
      summary: Cancel a Job
      description: >
        Stop execution of Job identified by JobID. Returns 204 on success. If
        Job does not exist, 404 response will be returned. If the Job is
        already in final state, 403 response will be returned.
      operationId: JobCanceler
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: path
          required: true
          name: JobID
          type: integer
          format: uint64
      responses:
        '204':
          description: No Content
        '404':
          $ref: '#/responses/NotFound'
        '403':
          $ref: '#/responses/Forbidden'
        '500':
          $ref: '#/responses/InternalServer'
  /jobs/list:
    options:
      tags:
        - jobs
      summary: OPTIONS path for CORS.
      description: ""
      operationId: JobListerOptions
      responses:
         '200':
          description: 200 OK
          headers:
            Access-Control-Allow-Origin:
              type: string
            Access-Control-Allow-Headers:
              type: array
              items:
                type: string
              collectionFormat: csv
            Access-Control-Allow-Methods:
              type: array
              items:
                type: string
              collectionFormat: csv
    post:
      tags:
        - jobs
      summary: List Jobs with filtering, sorting and pagination.
      description: >
        Returns sorted list of Jobs. If there are more records than returned
        page, 206 response is returned. If the page is last - 200 response is
        returned. If no Jobs satisfy passed filter, 404 response is returned.
      operationId: JobLister
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: jobFilterAndSort
          description: Job Filter and Sort object.
          required: false
          schema:
            description: Data for filtering and sorting Weles Jobs lists.
            type: object
            properties:
              Filter:
                $ref: '#/definitions/JobFilter'
              Sorter:
                $ref: '#/definitions/JobSorter'
        - in: query
          name: after
          description: >
            Fill this parameter with JobID of the last element from current
            page to receive next one.
          type: integer
          format: uint64
        - in: query
          name: before
          description: >
            Fill this parameter with JobID of the first element from current
            page to receive previous one.
          type: integer
          format: uint64
        - in: query
          name: limit
          description:  >
            Number of records to return. Overrides default server page limit.
          type: integer
          format: int32
      responses:
        '200':
          description: OK
          schema:
            type: array
            items:
              $ref: '#/definitions/JobInfo'
          headers:
            Previous:
              type: string
              format: URI
              description: >
                URL suffix to request previous page of data. Please note that
                the same body must be used as in initial request.
            Next:
              type: string
              format: URI
              description: >
                URL suffix to request next page of data. Please note that the
                same body must be used as in initial request.
            TotalRecords:
              type: integer
              format: uint64
              description: >
                count of records currently fulfilling the requested JobFilter.
                Please note that this value may change when requesting for the
                same data at a different moments in time.
        '206':
          description: Partial Content
          schema:
            type: array
            items:
              $ref: '#/definitions/JobInfo'
          headers:
            Previous:
              type: string
              format: URI
              description: >
                URL suffix to request previous page of data. Please note that
                the same body must be used as in initial request.
            Next:
              type: string
              format: URI
              description: >
                URL suffix to request next page of data. Please note that the
                same body must be used as in initial request.
            TotalRecords:
              type: integer
              format: uint64
              description: >
                 count of records currently fulfilling requested JobFilter.
                 Please note that this value may change when requesting for the
                 same data at a different moments in time.
            RemainingRecords:
              type: integer
              format: uint64
              description: >
                number of records after current page. Please note that this
                value may change when requesting for the same data at a
                different moments in time.
        '400':
          $ref: '#/responses/BadRequest'
        '404':
          $ref: '#/responses/NotFound'
        '500':
          $ref: '#/responses/InternalServer'
  /artifacts/list:
    options:
      tags:
        - artifacts
      summary: OPTIONS path for CORS.
      description: ""
      operationId: ArtifactListerOptions
      responses:
         '200':
          description: 200 OK
          headers:
            Access-Control-Allow-Origin:
              type: string
            Access-Control-Allow-Headers:
              type: array
              items:
                type: string
              collectionFormat: csv
            Access-Control-Allow-Methods:
              type: array
              items:
                type: string
              collectionFormat: csv
    post:
      tags:
        - artifacts
      summary: List Artifacts with filter and sort features
      description: >
        Returns sorted list of Artifacts. If there are more records than
        default page size -  206 response is returned. If the page is last -
        200 response is returned. If no Artifact passes filter - 404 response
        is returned.
      operationId: ArtifactLister
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: artifactFilterAndSort
          description: Artifact Filter and Sort object.
          required: false
          schema:
            description: Data for filtering and sorting Weles Jobs lists.
            type: object
            properties:
              Filter:
                $ref: '#/definitions/ArtifactFilter'
              Sorter:
                $ref: '#/definitions/ArtifactSorter'
        - in: query
          name: after
          description: >
            Fill this parameter with ID (not JobID) of the last
            element from current page to receive next one.
          type: integer
          format: int64
        - in: query
          name: before
          description: >
            Fill this parameter with ID (not JobID) of first element from
            current page to receive previous one.
          type: integer
          format: int64
        - in: query
          name: limit
          description: >
            Number of records to return. Overrides default server page limit.
          type: integer
          format: int32
      responses:
        '200':
          description: OK
          schema:
            type: array
            items:
              $ref: '#/definitions/ArtifactInfo'
          headers:
            Previous:
              type: string
              format: URI
              description: >
                URL suffix to request next page of data. Please note that the same body must be used as in initial request.
            Next:
              type: string
              format: URI
              description: >
                URI to request next page of data. Please note that the same body must be used as in initial request.
            TotalRecords:
              type: integer
              format: uint64
              description: >
                count of records currently fulfilling the requested ArtifactFilter. Please note that this value may change when requesting for the same data at a different moment in time.
        '206':
          description: Partial Content
          schema:
            type: array
            items:
              $ref: '#/definitions/ArtifactInfo'
          headers:
            Previous:
              type: string
              format: URI
              description: >
                URI to request next page of data. Please note that the same body must be used as in initial request.
            Next:
              type: string
              format: URI
              description: >
                URI to request next page of data. Please note that the same body must be used as in initial request.
            TotalRecords:
              type: integer
              format: uint64
              description: >
                count of records currently fulfilling the requested ArtifactFilter. Please note that this value may change when requesting for the same data at a different moment in time.
            RemainingRecords:
              type: integer
              format: uint64
              description: >
                number of records after current page. Please note that this value may change when requesting for the same data at a different moment in time.
        '400':
          $ref: '#/responses/BadRequest'
        '404':
          $ref: '#/responses/NotFound'
        '500':
          $ref: '#/responses/InternalServer'
  /version:
    get:
      tags:
        - general
      summary: Show current version of Weles internals
      description: Version and state of API (e.g. v1 obsolete, v2 stable,
                   v3 devel) and server version.
      operationId: Version
      produces:
        - application/json
      responses:
        '200':
          description: OK
          schema:
            $ref: '#/definitions/Version'
          headers:
            Weles-Server-Version:
              type: string
              description: Version of Weles server.
            Weles-API-Version:
              type: string
              description: Version of Weles API.
            Weles-API-State:
              type: string
              description: State of Weles API.
        '500':
          $ref: '#/responses/InternalServer'
responses:
  BadRequest:
    description: Bad Request
    schema:
      $ref: '#/definitions/ErrResponse'
  NotFound:
    description: Not Found
    schema:
      $ref: '#/definitions/ErrResponse'
  Forbidden:
    description: Forbidden
    schema:
      $ref: '#/definitions/ErrResponse'
  UnsupportedMediaType:
    description: Unsupported media type
    schema:
      $ref: '#/definitions/ErrResponse'
  UnprocessableEntity:
    description: Unprocessable entity
    schema:
      $ref: '#/definitions/ErrResponse'
  InternalServer:
    description: Internal Server error
    schema:
      $ref: '#/definitions/ErrResponse'
definitions:
  JobID:
    description: is a unique identifier for Weles Job.
    type: integer
    format: uint64
  JobStatus:
    description: |
      specifies state of the Job.

      * NEW - The new Job has been created.

      * PARSING - Provided yaml file is being parsed and interpreted.

      * DOWNLOADING - Images and/or files required for the test are being downloaded.

      * WAITING - Job is waiting for Boruta worker.

      * RUNNING - Job is being executed.

      * COMPLETED - Job is completed. This is terminal state.

      * FAILED - Job execution has failed. This is terminal state.

      * CANCELED -Job has been canceled with API call. This is terminal state.

    type: string
    enum:
      - NEW
      - PARSING
      - DOWNLOADING
      - WAITING
      - RUNNING
      - COMPLETED
      - FAILED
      - CANCELED
  JobInfo:
    description: contains information about a Job available for public API.
    type: object
    properties:
      jobID:
        $ref: '#/definitions/JobID'
        description: is a unique Job identifier
      name:
        type: string
        description: is the Job name acquired from yaml file during Job creation.
      created:
        type: string
        format: date-time
        description: is the Job creation time in UTC.
      updated:
        type: string
        format: date-time
        description: is the time of latest Jobs' status modification.
      status:
        $ref: '#/definitions/JobStatus'
        description: specifies current state of the Job.
      info:
        type: string
        description: provides additional information about current state, e.g. cause of failure
  JobFilter:
    description: >
      is used to filter Weles Jobs. Filling more than one struct member (e.g.
      JobID, Name) will result in searching for a Job with filled JobID and
      Name. Filling more than one member of an array/slice (in specific struct
      member) will result in searching for all members of array. Both
      aforementioned behaviours may occur simultainously. Some JobFilter fields
      support regular expressions (see documentation of struct)
    type: object
    properties:
      JobID:
        type: array
        items:
          $ref: '#/definitions/JobID'
      Name:
        description: Allows usage of regular expressions.
        type: array
        items:
          type: string
      CreatedAfter:
        type: string
        format: date-time
      CreatedBefore:
        type: string
        format: date-time
      UpdatedAfter:
        type: string
        format: date-time
      UpdatedBefore:
        type: string
        format: date-time
      Status:
        type: array
        items:
          $ref: '#/definitions/JobStatus'
      Info:
        description: Allows usage of regular expressions.
        type: array
        items:
          type: string
  JobSortBy:
    description: |
      denotes key for sorting Jobs list.

      * ID - default sort key.

      * CreatedDate - sorting by date of creation of the weles Job.

      * UpdatedDate - sorting by date of update of the weles Job.

      * JobStatus - sorting by the Job Status. Descending order will sort in the order JobStatuses are listed in the docs (from NEW at the start to CANCELED at the end). Ascending will reverse this order.

      When sorting is applied, and there are many Jobs with the same date/status, they will be sorted by JobID (Ascending)
    type: string
    enum:
      - ID
      - CreatedDate
      - UpdatedDate
      - JobStatus
  SortOrder:
    description: |
      denotes direction of sorting of weles Jobs or Artifacts.

      * Ascending - from oldest to newest.

      * Descending - from newest to oldest.

    type: string
    enum:
      - Ascending
      - Descending
  JobSorter:
    description: |
      defines the key for sorting as well as direction of sorting.
    type: object
    properties:
      By:
        $ref: '#/definitions/JobSortBy'
      Order:
        $ref: '#/definitions/SortOrder'
  ArtifactType:
    description: |
      denotes type and function of an Artifact.

      * IMAGE - image file.

      * RESULT - all outputs, files built during tests, etc.

      * TEST - additional files uploaded by user for conducting test.

      * YAML - yaml file describing Weles Job.

    type: string
    enum:
      - IMAGE
      - RESULT
      - TEST
      - YAML
  ArtifactPath:
    description: describes path to Artifact in ArtifactDB filesystem.
    type: string
  ArtifactStatus:
    description: |
      describes artifact status and availability.

      * DOWNLOADING - artifact is currently being downloaded.

      * READY - artifact has been downloaded and is ready to use.

      * FAILED - file is not available for use (e.g. download failed).

      * PENDING - artifact download has not started yet.

    type: string
    enum:
      - DOWNLOADING
      - READY
      - FAILED
      - PENDING
  ArtifactURI:
    description: is used to identify Artifact's source.
    type: string
    format: uri
  ArtifactAlias:
    description: is an alternative name of an Artifact.
    type: string
  ArtifactDescription:
    description: contains information needed to create new Artifact in ArtifactDB.
    type: object
    properties:
      JobID:
        $ref: '#/definitions/JobID'
        description: specifies  Job for which Artifact was created.
      Type:
        $ref: '#/definitions/ArtifactType'
      Alias:
        $ref: '#/definitions/ArtifactAlias'
      URI:
        $ref: '#/definitions/ArtifactURI'
  ArtifactInfo:
    description: describes single artifact stored in ArtifactDB.
    type: object
    allOf:
     - $ref: '#/definitions/ArtifactDescription'
    properties:
      Path:
        $ref: '#/definitions/ArtifactPath'
      Status:
        $ref: '#/definitions/ArtifactStatus'
      Timestamp:
        description: is date of creating the artifact.
        type: string
        format: date-time
      ID:
        description: unique identification of the artifact.
        type: integer
        format: int64
        x-go-custom-tag: "db:\",primarykey, autoincrement\""
  ArtifactFilter:
    description: is used to filter results from ArtifactDB.
    type: object
    properties:
      JobID:
        type: array
        items:
          $ref: '#/definitions/JobID'
      Type:
        type: array
        items:
          $ref: '#/definitions/ArtifactType'
      Status:
        type: array
        items:
          $ref: '#/definitions/ArtifactStatus'
      Alias:
        type: array
        items:
          $ref: '#/definitions/ArtifactAlias'
  ErrResponse:
    description: >-
      is a standard error response containing information about the
      error. It consists of error type and message.
    type: object
    properties:
      type:
        type: string
      message:
        type: string
  ArtifactSortBy:
    description: >
      denotes the key for sorting list of all artifacts.

      * ID - sorting by artifact ID.

    type: string
    enum:
      - ID
  ArtifactSorter:
    description: |
      defines the key for sorting as well as direction of sorting.
      When ArtifactSorter is empty, Artifacts are sorted by ID, Ascending.
    type: object
    properties:
      By:
        $ref: '#/definitions/ArtifactSortBy'
      Order:
        $ref: '#/definitions/SortOrder'
  Version:
    description: |
      defines version of Weles API (and its state) and server.
    type: object
    properties:
      Server:
        description: Version of Weles server.
        type: string
      API:
        description: Version of Weles API.
        type: string
      State:
        description: State of Weles API.
        type: string
        enum:
          - devel
          - stable
          - deprecated
externalDocs:
  description: Official Weles documentation.
  url: 'http://samsungslav.github.io/weles'

